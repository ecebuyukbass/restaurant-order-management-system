<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Garson Paneli</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-item-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-item-card .item-info {
            flex-grow: 1;
        }
        .order-item-card .remove-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body class="container mt-5">

<h1 class="text-center text-primary mb-4">üçù Garson Paneli</h1>

<div class="row">
    <div class="col-md-12 d-flex justify-content-between mb-4" id="table-buttons-container">
        <div th:each="i : ${#numbers.sequence(1, 5)}">
            <button type="button" class="btn btn-outline-dark me-2 table-button" th:data-table-number="${i}">
                Masa [[${i}]]
            </button>
        </div>
    </div>
</div>

<div id="menu-order-section" style="display:none;">
    <div class="row">
        <div class="col-md-6">
            <h4 class="mt-4">Men√º</h4>
            <div th:each="product : ${products}" class="card p-2 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="item-info">
                        <b th:text="${product.name}">√úr√ºn Adƒ±</b> -
                        <span th:text="${product.price} + '‚Ç∫'">Fiyat</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-success add-to-order-button"
                            th:data-product-id="${product.id}"
                            disabled>‚ûï Ekle</button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h3>Sipari≈ü √ñzeti (<span id="active-table-display">Masa se√ßilmedi</span>)</h3>
            <div id="order-summary-content" class="mb-3">
            </div>
            <div class="mt-3 d-flex gap-2">
                <button type="button" id="save-order-button" class="btn btn-success w-100" style="display: none;">Sipari≈üi Kaydet</button>
                <button type="button" id="reset-order-button" class="btn btn-warning w-100" style="display: none;">Hesabƒ± √ñdendi (Yerel)</button>
            </div>
            <div class="mt-2 d-flex gap-2">
                <button type="button" id="complete-order-button" class="btn btn-primary w-100" style="display: none;">Sipari≈üi Tamamla</button>
                <button type="button" id="delete-order-button" class="btn btn-danger w-100" style="display: none;">Hesabƒ± Sil</button>
            </div>
        </div>
    </div>
    <div class="text-center mt-3">
        <button type="button" id="back-to-tables-button" class="btn btn-secondary">‚Üê Masalara D√∂n</button>
    </div>
</div>

<script th:inline="javascript">
    // thymleaften gelen t√ºm √ºr√ºnleri global deƒüi≈ükene atamaya yarar
    window.allProducts = /*[[${products}]]*/ [];
</script>

<script>
    // dom element refleri
    const menuOrderSection = document.getElementById('menu-order-section');
    const activeTableDisplay = document.getElementById('active-table-display');
    const orderSummaryContent = document.getElementById('order-summary-content');
    const backToTablesButton = document.getElementById('back-to-tables-button');
    const saveOrderButton = document.getElementById('save-order-button');
    const resetOrderButton = document.getElementById('reset-order-button');
    const completeOrderButton = document.getElementById('complete-order-button');
    const deleteOrderButton = document.getElementById('delete-order-button');
    const addToOrderButtons = document.querySelectorAll('.add-to-order-button');
    const tableButtons = document.querySelectorAll('.table-button');

    let currentTable = null;
    let ordersByTable = {};
    let currentOrderId = {};

    document.addEventListener('DOMContentLoaded', () => {
        // masa butonlarƒ±na olay dinleyicileri ekleme (html'deki onclick yerine burasƒ± kullanƒ±lr)
        tableButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tableNumber = this.dataset.tableNumber;
                handleTableSelection(tableNumber);
            });
        });

        backToTablesButton.addEventListener('click', handleBackToTables);
        saveOrderButton.addEventListener('click', handleSaveOrder);
        resetOrderButton.addEventListener('click', handleResetOrder);
        completeOrderButton.addEventListener('click', handleCompleteOrder);
        deleteOrderButton.addEventListener('click', handleDeleteOrder);

        addToOrderButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.dataset.productId;
                handleAddProductToLocalOrder(productId);
            });
            button.disabled = true;
        });

        console.log(" T√ºm DOM √∂ƒüeleri y√ºklendi ve olay dinleyicileri eklendi");
        console.log("Mevcut √ºr√ºnler (window.allProducts):", window.allProducts);
    });

    /**
     * Masa se√ßildiƒüinde √ßaƒürƒ±lƒ±r. Men√ºy√º g√∂sterir, "Ekle" butonlarƒ±nƒ± etkinle≈ütirir
     * ve o masanƒ±n mevcut sipari≈üini (varsa) API'den √ßeker.
     * @param {string} tableNumber Se√ßilen masa numarasƒ±
     */
    function handleTableSelection(tableNumber) {
        currentTable = tableNumber;
        menuOrderSection.style.display = "block";
        activeTableDisplay.innerText = `Masa ${tableNumber}`;

        addToOrderButtons.forEach(btn => btn.disabled = false);

        ordersByTable[currentTable] = [];
        currentOrderId[currentTable] = null;
        renderOrderSummary();
        updateActionButtonsVisibility();

        fetch(`/api/orders/table/${tableNumber}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log(`Masa ${tableNumber} i√ßin aktif sipari≈ü bulunamadƒ± (404). Yeni sipari≈ü olu≈üturulabilir.`);
                        return Promise.reject("NO_ACTIVE_ORDER");
                    }
                    return response.text().then(text => { throw new Error(`API hatasƒ± (${response.status}): ${text}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.id) {
                    currentOrderId[currentTable] = data.id;
                    ordersByTable[currentTable] = [];
                    data.orderItems.forEach(item => {
                        const product = window.allProducts.find(p => String(p.id) === String(item.product.id));
                        if (product) {
                            for (let i = 0; i < item.quantity; i++) {
                                ordersByTable[currentTable].push(product);
                            }
                        }
                    });
                    console.log(`Masa ${tableNumber} i√ßin mevcut sipari≈ü y√ºklendi. ID: ${data.id}`);
                }
            })
            .catch(error => {
                if (error.message !== "NO_ACTIVE_ORDER") {
                    console.error("Mecut sipari≈ü y√ºklenirken hata:", error);
                    alert("mevcut sipari≈ü y√ºklenirken bir sorun olu≈ütu: " + error.message);
                }
            })
            .finally(() => {
                renderOrderSummary();
                updateActionButtonsVisibility();
            });
    }
    function handleBackToTables() {
        menuOrderSection.style.display = "none";
        currentTable = null;
        activeTableDisplay.innerText = "Masa se√ßilmedi";
        orderSummaryContent.innerHTML = "";
        addToOrderButtons.forEach(btn => btn.disabled = true);
        updateActionButtonsVisibility();
        console.log("Masalara d√∂n√ºld√º.");
    }

    /**
     * @param {string}

     */
    function handleAddProductToLocalOrder(productId) {
        if (!currentTable) {
            alert("L√ºtfen √∂nce bir masa se√ßin.");
            return;
        }

        const product = window.allProducts.find(p => String(p.id) === String(productId));
        if (!product) {
            console.error("√úr√ºn bulunamadƒ±, ID:", productId);
            return alert("√úr√ºn bulunamadƒ±!");
        }

        if (!ordersByTable[currentTable]) {
            ordersByTable[currentTable] = [];
        }

        ordersByTable[currentTable].push(product);
        renderOrderSummary();
        updateActionButtonsVisibility();
        console.log(`√úr√ºn ID ${productId} Masa ${currentTable} sepetine eklendi.`);
    }
    function renderOrderSummary() {
        orderSummaryContent.innerHTML = "";
        let total = 0;
        const currentTableOrders = ordersByTable[currentTable] || [];

        const groupedItemsDisplay = {};
        currentTableOrders.forEach(product => {
            if (groupedItemsDisplay[product.id]) {
                groupedItemsDisplay[product.id].quantity++;
            } else {
                groupedItemsDisplay[product.id] = { ...product, quantity: 1 };
            }
        });

        if (currentTableOrders.length === 0) {
            orderSummaryContent.innerHTML = "<div class='text-muted'>Hen√ºz √ºr√ºn eklenmedi.</div>";
        } else {
            Object.values(groupedItemsDisplay).forEach(item => {
                total += Number(item.price) * item.quantity;
                orderSummaryContent.innerHTML += `
                    <div class="card p-2 mb-2 bg-light order-item-card">
                        <span class="item-info">${item.name} (${item.quantity}x) - ${item.price * item.quantity}‚Ç∫</span>
                        <button type="button" class="btn btn-sm btn-danger remove-btn" data-product-id-to-remove="${item.id}">- Sil</button>
                    </div>
                `;
            });

            orderSummaryContent.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productIdToRemove = this.dataset.productIdToRemove;
                    removeItemFromLocalOrder(productIdToRemove);

                });
            });
        }
        orderSummaryContent.innerHTML += `<div class="mt-3 fw-bold">Toplam: ${total.toFixed(2)} ‚Ç∫</div>`;
    }

    /**
     * @param {string}
     */
    function removeItemFromLocalOrder(productIdToRemove) {
    console.log("üß™ Silme fonksiyonu √ßalƒ±≈ütƒ±. Silinecek √ºr√ºn ID:", productIdToRemove);

    if (currentTable && ordersByTable[currentTable]) {
        console.log("üì¶ Mevcut sepet i√ßeriƒüi:", ordersByTable[currentTable]);

        const index = ordersByTable[currentTable].findIndex(p =>
            String(p.id) === String(productIdToRemove)
        );

        if (index > -1) {
            ordersByTable[currentTable].splice(index, 1);
            console.log(` √úr√ºn ID ${productIdToRemove} ba≈üarƒ±yla silindi.`);

            renderOrderSummary();
            updateActionButtonsVisibility();
        } else {
            console.warn(`√úr√ºn ID ${productIdToRemove} sepet i√ßinde bulunamadƒ±!`);
        }
    } else {
        console.error(" currentTable tanƒ±msƒ±z veya sepet bo≈ü.");
    }
}



    function updateActionButtonsVisibility() {
        const hasLocalOrders = currentTable && ordersByTable[currentTable] && ordersByTable[currentTable].length > 0;
        const hasApiOrder = currentTable && currentOrderId[currentTable];

        saveOrderButton.style.display = 'none';
        resetOrderButton.style.display = 'none';
        completeOrderButton.style.display = 'none';
        deleteOrderButton.style.display = 'none';

        if (hasApiOrder) {
            completeOrderButton.style.display = 'block';
            deleteOrderButton.style.display = 'block';
        } else if (hasLocalOrders) {
            saveOrderButton.style.display = 'block';
            resetOrderButton.style.display = 'block';
        }
    }

    async function handleSaveOrder() {
        const currentTableOrders = ordersByTable[currentTable];
        if (!currentTableOrders || currentTableOrders.length === 0) {
            return alert("Kaydedilecek sipari≈ü yok!");
        }

        const itemCounts = {};
        currentTableOrders.forEach(product => {
            if (itemCounts[product.id]) {
                itemCounts[product.id].quantity++;
            } else {
                itemCounts[product.id] = { productId: product.id, quantity: 1 };
            }
        });

        const itemsToSend = Object.values(itemCounts);

        const orderData = {
            tableNumber: String(currentTable),
            items: itemsToSend
        };

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(orderData)
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => null) || await response.text().catch(() => 'Bilinmeyen Hata');
                throw new Error(`Sipari≈üi kaydetme ba≈üarƒ±sƒ±z oldu: ${response.status} - ${typeof errorBody === 'object' ? JSON.stringify(errorBody) : errorBody}`);
            }

            const savedOrder = await response.json();
            currentOrderId[currentTable] = savedOrder.id;
            alert(`sipari≈ü ba≈üarƒ±yla kaydedildi siparis id: ${savedOrder.id}`);
            updateActionButtonsVisibility();
            console.log("Sipari≈ü ba≈üarƒ±yla kaydedildi:", savedOrder);

        } catch (error) {
            console.error("sipari≈üi kaydederken hata olu≈ütu:", error);
            alert("sipari≈üi kaydederken bir sorun olu≈ütu: " + error.message);
        }
    }

    async function handleCompleteOrder() {
        if (!currentTable) {
            return alert("L√ºtfen √∂nce bir masa se√ßin.");
        }
        const orderIdToComplete = currentOrderId[currentTable];
        if (!orderIdToComplete) {
            return alert("Tamamlanacak kaydedilmi≈ü bir sipari≈ü bulunamadƒ±.");
        }

        if (!confirm(`Masa ${currentTable} i√ßin sipari≈üi TAMAMLAMAK istediƒüinizden emin misiniz?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/orders/complete/${orderIdToComplete}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => null) || await response.text().catch(() => 'Bilinmeyen Hata');
                throw new Error(`Sipari≈ü tamamlanamadƒ±: ${response.status} - ${typeof errorBody === 'object' ? JSON.stringify(errorBody) : errorBody}`);
            }

            alert(`Masa ${currentTable} sipari≈üi ba≈üarƒ±yla tamamlandƒ±.`);
            ordersByTable[currentTable] = [];
            currentOrderId[currentTable] = null;
            renderOrderSummary();
            updateActionButtonsVisibility();
        } catch (error) {
            console.error("Sipari≈üi tamamlarken hata olu≈ütu:", error);
            alert("Sipari≈üi tamamlarken bir sorun olu≈ütu: " + error.message);
        }
    }


    async function handleDeleteOrder() {
        if (!currentTable) {
            return alert("L√ºtfen √∂nce bir masa se√ßin.");
        }
        const orderIdToDelete = currentOrderId[currentTable];
        if (!orderIdToDelete) {
            return alert("Silinecek kaydedilmi≈ü bir sipari≈ü bulunamadƒ±.");
        }

        if (!confirm(`Masa ${currentTable} i√ßin sipari≈üi tamamen Sƒ∞LMEK istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) {
            return;
        }

        try {
            const response = await fetch(`/api/orders/${orderIdToDelete}`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => null) || await response.text().catch(() => 'Bilinmeyen Hata');
                throw new Error(`Sipari≈ü silinemedi: ${response.status} - ${typeof errorBody === 'object' ? JSON.stringify(errorBody) : errorBody}`);
            }

            alert(`Masa ${currentTable} sipari≈üi ba≈üarƒ±yla silindi.`);
            ordersByTable[currentTable] = [];
            currentOrderId[currentTable] = null;
            renderOrderSummary();
            updateActionButtonsVisibility();
        } catch (error) {
            console.error("Sipari≈üi silerken hata olu≈ütu:", error);
            alert("Sipari≈üi silerken bir sorun olu≈ütu: " + error.message);
        }
    }


    function handleResetOrder() {
        if (confirm(`Masa ${currentTable} i√ßin hesabƒ± √∂denmi≈ü olarak i≈üaretleyip yerel sepeti temizlemek istediƒüinizden emin misiniz? (API'ye istek g√∂nderilmez)`)) {
            ordersByTable[currentTable] = [];
            currentOrderId[currentTable] = null;
            renderOrderSummary();
            updateActionButtonsVisibility();
            alert(`Masa ${currentTable} sepeti yerel olarak temizlendi.`);
            console.log(`Masa ${currentTable} sepeti temizlendi (Hesap √ñdendi).`);
        }
    }

     document.getElementById('order-summary-content').addEventListener('click', function(event) {
      if (event.target && event.target.classList.contains('remove-btn')) {
          const productIdToRemove = event.target.dataset.productIdToRemove;
          console.log("Delegation ile Sil'e tƒ±klandƒ±! ID:", productIdToRemove);
          removeItemFromLocalOrder(productIdToRemove);
      }
  });
</script>

</body>
</html>